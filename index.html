<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>57萬獵人策略 v2.1 | 歷史追蹤版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 12px; }
        .accent-gradient { background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%); }
        .status-wait { color: #94a3b8; border: 1px solid #475569; }
        .status-attack { background-color: #065f46; color: #34d399; border: 1px solid #059669; }
        .status-alert { background-color: #7f1d1d; color: #f87171; border: 1px solid #dc2626; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        table { width: 100%; text-align: left; }
        th { color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; padding: 12px; border-bottom: 1px solid #334155; }
        td { padding: 12px; border-bottom: 1px solid #1e293b; font-size: 0.875rem; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold accent-gradient bg-clip-text text-transparent">57萬獵人策略 v2.1</h1>
                <p id="data-date" class="text-slate-400 text-sm">數據驅動決策系統</p>
            </div>
            <div class="flex gap-2">
                <button onclick="clearHistory()" class="bg-red-900/30 hover:bg-red-900/50 text-red-400 border border-red-900 px-3 py-2 rounded-lg text-xs transition">清除歷史</button>
                <button onclick="toggleSyncModal()" class="bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded-lg text-sm font-bold transition">同步最新情報</button>
            </div>
        </header>

        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="card p-6 h-fit">
                <h2 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">戰略參數</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">總投資預算 (TWD)</label>
                        <input type="number" id="input-capital" value="570000" onchange="calculate()" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sky-400 font-bold">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">預期 ROI 目標: <span id="roi-val-display" class="text-sky-400">15%</span></label>
                        <input type="range" id="input-roi" min="5" max="50" value="15" oninput="updateRoiDisplay()" onchange="calculate()" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500">
                    </div>
                </div>
            </div>

            <div class="md:col-span-2 space-y-6">
                <div id="status-card" class="status-wait rounded-xl p-6 text-center transition-all duration-500">
                    <p class="text-xs uppercase tracking-widest mb-1 opacity-80">決策指令</p>
                    <h3 id="action-text" class="text-3xl font-black mb-2 italic">等待同步</h3>
                    <p id="action-desc" class="text-xs">請貼入 Gemini 提供的 Intelligence Code</p>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="card p-4">
                        <p class="text-slate-400 text-[10px] uppercase">TSM ADR</p>
                        <p id="adr-price" class="text-lg font-bold">--</p>
                    </div>
                    <div class="card p-4">
                        <p class="text-slate-400 text-[10px] uppercase">3711 P/E</p>
                        <p id="res-pe" class="text-lg font-bold text-sky-400">--</p>
                    </div>
                    <div class="card p-4">
                        <p class="text-slate-400 text-[10px] uppercase">目標出場價</p>
                        <p id="res-target-price" class="text-lg font-bold text-emerald-400">--</p>
                    </div>
                    <div class="card p-4">
                        <p class="text-slate-400 text-[10px] uppercase">2330 零股</p>
                        <p id="res-2330-share" class="text-lg font-bold">--</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card overflow-hidden">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h2 class="font-bold">歷史趨勢追蹤 (Intelligence Log)</h2>
                <span class="text-xs text-slate-500">自動記錄每日變化</span>
            </div>
            <div class="overflow-x-auto">
                <table id="history-table">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>ADR 價格</th>
                            <th>ADR 漲跌</th>
                            <th>3711 P/E</th>
                            <th>決策指令</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="sync-modal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50">
            <div class="card w-full max-w-lg p-6">
                <h2 class="text-xl font-bold mb-2">同步市場情報</h2>
                <textarea id="json-input" rows="8" class="w-full bg-slate-900 border border-slate-700 rounded p-4 font-mono text-xs text-emerald-400 mb-4" placeholder="貼入 JSON 代碼..."></textarea>
                <div class="flex gap-3">
                    <button onclick="processJson()" class="flex-1 bg-sky-600 hover:bg-sky-500 py-3 rounded-xl font-bold">更新並記錄</button>
                    <button onclick="toggleSyncModal()" class="flex-1 bg-slate-700 py-3 rounded-xl">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let marketData = null;
        let history = JSON.parse(localStorage.getItem('hunter_history') || '[]');

        window.onload = () => {
            if(localStorage.getItem('hunter_capital')) document.getElementById('input-capital').value = localStorage.getItem('hunter_capital');
            if(localStorage.getItem('hunter_roi')) document.getElementById('input-roi').value = localStorage.getItem('hunter_roi');
            updateRoiDisplay();
            renderHistory();
            
            const lastData = localStorage.getItem('hunter_last_data');
            if(lastData) {
                marketData = JSON.parse(lastData);
                updateMarketUI();
                calculate();
            }
        };

        function toggleSyncModal() { document.getElementById('sync-modal').classList.toggle('hidden'); }
        function updateRoiDisplay() { document.getElementById('roi-val-display').innerText = document.getElementById('input-roi').value + '%'; }

        function processJson() {
            const raw = document.getElementById('json-input').value;
            try {
                const newData = JSON.parse(raw);
                marketData = newData;
                localStorage.setItem('hunter_last_data', raw);
                
                // Add to history if date is new
                const exists = history.find(h => h.date === newData.date);
                if (!exists) {
                    const pe = (newData.stock_3711_current / newData.eps_2026_est).toFixed(1);
                    let action = "潛伏";
                    if (pe <= 23.5) action = "進場";
                    if (newData.stock_3711_current <= 300) action = "轉向2330";
                    
                    history.unshift({
                        date: newData.date,
                        adr: newData.tsm_adr,
                        change: newData.adr_change,
                        pe: pe,
                        action: action
                    });
                    localStorage.setItem('hunter_history', JSON.stringify(history));
                }
                
                updateMarketUI();
                calculate();
                renderHistory();
                toggleSyncModal();
            } catch (e) { alert("格式錯誤，請重新複製。"); }
        }

        function renderHistory() {
            const body = document.getElementById('history-body');
            body.innerHTML = history.map(h => `
                <tr>
                    <td class="font-mono text-slate-400">${h.date}</td>
                    <td class="font-bold">$${h.adr}</td>
                    <td class="${h.change >= 0 ? 'text-emerald-400' : 'text-red-400'}">${h.change}%</td>
                    <td class="text-sky-400 font-bold">${h.pe}x</td>
                    <td>
                        <span class="px-2 py-1 rounded text-[10px] ${h.action === '進場' ? 'bg-emerald-900 text-emerald-300' : h.action === '轉向2330' ? 'bg-red-900 text-red-300' : 'bg-slate-800 text-slate-400'}">
                            ${h.action}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function clearHistory() {
            if(confirm("確定要清除所有歷史紀錄嗎？")) {
                history = [];
                localStorage.removeItem('hunter_history');
                renderHistory();
            }
        }

        function updateMarketUI() {
            if(!marketData) return;
            document.getElementById('adr-price').innerText = "$" + marketData.tsm_adr;
            document.getElementById('stock-3711-price-display')?.innerText = marketData.stock_3711_current + " 元";
        }

        function calculate() {
            if(!marketData) return;
            const capital = parseFloat(document.getElementById('input-capital').value);
            const roi = parseFloat(document.getElementById('input-roi').value) / 100;
            localStorage.setItem('hunter_capital', capital);
            localStorage.setItem('hunter_roi', document.getElementById('input-roi').value);

            const pe = (marketData.stock_3711_current / marketData.eps_2026_est).toFixed(1);
            document.getElementById('res-pe').innerText = pe + "x";
            document.getElementById('res-target-price').innerText = (marketData.stock_3711_current * (1 + roi)).toFixed(1) + " 元";

            const remain = capital - (1000 * marketData.stock_3711_current);
            document.getElementById('res-2330-share').innerText = remain > 0 ? Math.floor(remain / marketData.stock_2330_est) + " 股" : "預算不足";

            const sc = document.getElementById('status-card');
            const at = document.getElementById('action-text');
            const ad = document.getElementById('action-desc');

            if (marketData.stock_3711_current <= 300) {
                sc.className = "status-alert rounded-xl p-6 text-center transition-all";
                at.innerText = "轉向 2330"; ad.innerText = "偵測到系統性風險，執行避險。";
            } else if (pe <= 23.5) {
                sc.className = "status-attack rounded-xl p-6 text-center transition-all";
                at.innerText = "ATTACK! 進場"; ad.innerText = "符合價值區間，執行買入。";
            } else {
                sc.className = "status-wait rounded-xl p-6 text-center transition-all";
                at.innerText = "WAITING 潛伏"; ad.innerText = "估值偏高，等待更好的 Entry。";
            }
        }
    </script>
</body>
</html>
