// 修改後的 handleFileUpload 函式 (v5.1)
function handleFileUpload(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
        const rawData = JSON.parse(e.target.result);
        
        // 判斷是單筆還是多筆數據
        const dataArray = Array.isArray(rawData) ? rawData : [rawData];
        
        dataArray.forEach(data => {
            if (!history.find(h => h.date === data.date)) {
                const adrConv = data.tsm_adr / 5 * 31.36;
                const prem = ((adrConv / data.stock_2330_current) - 1) * 100;
                history.push({
                    date: data.date,
                    adr: data.tsm_adr,
                    adrConv: adrConv,
                    p2330: data.stock_2330_current,
                    p3711: data.stock_3711_current,
                    premium: prem,
                    target3711: parseFloat(document.getElementById('target-3711').value) || (data.stock_3711_current * 0.96),
                    target2330: parseFloat(document.getElementById('target-2330').value) || (data.stock_2330_current * 0.95)
                });
            }
        });
        
        // 排序確保時間軸正確
        history.sort((a, b) => new Date(a.date) - new Date(b.date));
        localStorage.setItem('h50_history', JSON.stringify(history));
        
        marketData = dataArray[dataArray.length - 1]; // 以最後一筆作為即時數據
        localStorage.setItem('h50_last_data', JSON.stringify(marketData));
        
        updateMarketUI();
        renderHistory();
        updateCharts();
        calculate();
    };
    reader.readAsText(file);
}
